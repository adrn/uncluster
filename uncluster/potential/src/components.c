#include <stdlib.h>
#include <math.h>
#include <potential/builtin/builtin_potentials.h>
#include <gsl/gsl_errno.h>
#include <gsl/gsl_interp.h>
#include <gsl/gsl_spline.h>
#include "cosmo_arrays.h"

/* ---------------------------------------------------------------------------
    Some global parameters that we set up here for speed
*/
static double const M_vir0 = 1e12; // Solar masses
static double const R_vir0 = 264.31575; // kpc, computed using Astropy for the above mass

// See scripts/make-cosmo-interp-grid.py if modifying these values.
// These grids assume the unit system [Myr, kpc, Msun]
static int const interp_grid_size = 256; // Set in Python when generating grids
static double t_grid[]     = {-12256.511389181127, -12208.446638635318, -12160.38188808951, -12112.317137543701, -12064.25238699789, -12016.187636452085, -11968.122885906276, -11920.058135360467, -11871.99338481466, -11823.928634268852, -11775.863883723043, -11727.799133177234, -11679.734382631425, -11631.669632085617, -11583.60488153981, -11535.540130994, -11487.475380448192, -11439.410629902384, -11391.345879356577, -11343.281128810768, -11295.216378264959, -11247.15162771915, -11199.086877173344, -11151.022126627535, -11102.957376081726, -11054.892625535917, -11006.82787499011, -10958.7631244443, -10910.698373898493, -10862.633623352684, -10814.568872806874, -10766.504122261069, -10718.43937171526, -10670.37462116945, -10622.309870623643, -10574.245120077836, -10526.180369532025, -10478.115618986218, -10430.050868440409, -10381.9861178946, -10333.921367348794, -10285.856616802985, -10237.791866257176, -10189.727115711366, -10141.66236516556, -10093.59761461975, -10045.532864073943, -9997.468113528133, -9949.403362982326, -9901.338612436519, -9853.27386189071, -9805.2091113449, -9757.144360799091, -9709.079610253284, -9661.014859707475, -9612.950109161668, -9564.885358615858, -9516.820608070051, -9468.755857524244, -9420.691106978433, -9372.626356432625, -9324.561605886818, -9276.496855341009, -9228.432104795202, -9180.367354249393, -9132.302603703583, -9084.237853157776, -9036.173102611969, -8988.108352066158, -8940.04360152035, -8891.978850974543, -8843.914100428734, -8795.849349882927, -8747.784599337117, -8699.719848791308, -8651.655098245501, -8603.590347699692, -8555.525597153883, -8507.460846608075, -8459.396096062268, -8411.331345516459, -8363.266594970652, -8315.201844424842, -8267.137093879035, -8219.072343333226, -8171.007592787417, -8122.942842241609, -8074.878091695801, -8026.813341149992, -7978.748590604185, -7930.683840058376, -7882.6190895125665, -7834.554338966758, -7786.489588420951, -7738.424837875142, -7690.360087329334, -7642.295336783525, -7594.230586237718, -7546.16583569191, -7498.101085146101, -7450.036334600291, -7401.971584054483, -7353.906833508676, -7305.842082962867, -7257.777332417059, -7209.712581871251, -7161.647831325443, -7113.583080779633, -7065.5183302338255, -7017.453579688017, -6969.388829142209, -6921.324078596401, -6873.259328050592, -6825.194577504784, -6777.129826958976, -6729.065076413168, -6681.000325867358, -6632.9355753215505, -6584.870824775742, -6536.806074229934, -6488.741323684126, -6440.6765731383175, -6392.611822592509, -6344.547072046699, -6296.482321500892, -6248.417570955083, -6200.352820409275, -6152.288069863467, -6104.223319317659, -6056.158568771851, -6008.0938182260425, -5960.029067680233, -5911.964317134426, -5863.899566588617, -5815.834816042809, -5767.770065497, -5719.705314951192, -5671.640564405384, -5623.575813859575, -5575.511063313767, -5527.446312767958, -5479.38156222215, -5431.316811676342, -5383.2520611305345, -5335.187310584725, -5287.122560038918, -5239.057809493109, -5190.9930589473, -5142.928308401492, -5094.863557855683, -5046.798807309875, -4998.734056764067, -4950.669306218259, -4902.60455567245, -4854.539805126642, -4806.475054580834, -4758.410304035026, -4710.345553489216, -4662.280802943409, -4614.216052397601, -4566.151301851792, -4518.086551305984, -4470.021800760175, -4421.957050214367, -4373.892299668559, -4325.8275491227505, -4277.762798576941, -4229.698048031134, -4181.633297485326, -4133.568546939518, -4085.5037963937084, -4037.4390458479006, -3989.3742953020924, -3941.3095447562832, -3893.2447942104754, -3845.180043664667, -3797.115293118859, -3749.0505425730503, -3700.9857920272416, -3652.9210414814333, -3604.8562909356256, -3556.7915403898164, -3508.7267898440086, -3460.6620392982004, -3412.597288752392, -3364.532538206584, -3316.4677876607752, -3268.403037114967, -3220.3382865691588, -3172.2735360233496, -3124.2087854775414, -3076.1440349317336, -3028.0792843859253, -2980.0145338401167, -2931.9497832943084, -2883.8850327485, -2835.820282202692, -2787.7555316568837, -2739.690781111075, -2691.6260305652672, -2643.561280019459, -2595.49652947365, -2547.4317789278416, -2499.3670283820334, -2451.302277836225, -2403.237527290417, -2355.172776744608, -2307.1080261988004, -2259.043275652992, -2210.9785251071835, -2162.9137745613752, -2114.849024015567, -2066.784273469759, -2018.7195229239503, -1970.6547723781416, -1922.5900218323336, -1874.5252712865251, -1826.4605207407167, -1778.3957701949082, -1730.3310196491002, -1682.266269103292, -1634.2015185574835, -1586.1367680116748, -1538.0720174658668, -1490.0072669200583, -1441.94251637425, -1393.8777658284419, -1345.8130152826336, -1297.748264736825, -1249.6835141910167, -1201.6187636452084, -1153.5540130994002, -1105.4892625535917, -1057.4245120077835, -1009.3597614619752, -961.2950109161668, -913.2302603703583, -865.1655098245501, -817.1007592787417, -769.0360087329334, -720.971258187125, -672.9065076413168, -624.8417570955083, -576.7770065497001, -528.7122560038918, -480.6475054580834, -432.58275491227505, -384.5180043664667, -336.4532538206584, -288.38850327485005, -240.3237527290417, -192.25900218323335, -144.19425163742503, -96.12950109161667, -48.06475054580834, -0.0};
static double z_grid[]     = {3.9999999758017815, 3.8981803599959854, 3.8013384918618844, 3.7090940282075975, 3.6211053797595953, 3.5370651296784636, 3.4566953093411175, 3.3797443553772712, 3.3059836918756402, 3.235205255450676, 3.1672192618558133, 3.1018519754627554, 3.038944346541567, 2.9783502327740545, 2.9199351246016376, 2.8635750682001104, 2.8091556349074844, 2.756570882670525, 2.7057227549074345, 2.6565201970840766, 2.6088785677671047, 2.562719141451938, 2.5179685543309747, 2.4745582686996985, 2.432424267920873, 2.3915067282431295, 2.351749570629253, 2.3131002135304284, 2.2755092337926195, 2.2389302568454372, 2.2033196513356765, 2.1686362964796713, 2.134841414001934, 2.1018985144427274, 2.0697730042693414, 2.038432327884751, 2.0078455821957024, 1.9779835340019194, 1.9488184796339691, 1.9203242079903156, 1.8924757671768888, 1.8652495203453805, 1.8386229222078527, 1.8125746333865487, 1.7870843007163428, 1.762132497389184, 1.7377007772897508, 1.7137715721603513, 1.6903280049527416, 1.6673540718313056, 1.644834421840686, 1.62275447419116, 1.6011001576707327, 1.5798581151779552, 1.5590155139496928, 1.5385600309790408, 1.5184799597640266, 1.4987639715955279, 1.4794012436410648, 1.4603814104508421, 1.441694471892329, 1.4233308429450167, 1.4052813792174113, 1.3875371561918668, 1.3700897328691446, 1.3529308667571058, 1.3360526994432225, 1.3194476612542794, 1.3031084217398619, 1.2870279454156117, 1.2711994266986992, 1.255616358859239, 1.2402723970091147, 1.2251614424050732, 1.2102776532633042, 1.1956152839076994, 1.1811689184528298, 1.1669332063772477, 1.1529030434536611, 1.1390734663326563, 1.125439690299223, 1.1119970824240326, 1.0987411413923474, 1.0856675301998588, 1.0727720393024618, 1.0600506275290924, 1.0474993090942797, 1.035114291194337, 1.0228918348077967, 1.0108283820302895, 0.9989204040032662, 0.9871645790521468, 0.9755575737410698, 0.9640962292591405, 0.952777431803225, 0.941598221193859, 0.9305556426758637, 0.9196468802674367, 0.9088691993760639, 0.89821989917977, 0.8876963805151261, 0.8772961379003981, 0.8670166864787304, 0.8568556589754022, 0.8468107119072201, 0.8368795932719588, 0.8270601001254612, 0.8173500723938958, 0.8077474365385916, 0.7982501597131219, 0.7888562470670651, 0.7795637911487334, 0.7703708808665553, 0.7612757193426964, 0.7522764944972204, 0.7433714752781915, 0.7345589425911764, 0.7258372784087315, 0.7172048448148197, 0.7086600606848587, 0.7002013951010883, 0.6918273655740406, 0.6835364800441076, 0.6753273225059648, 0.6671984978705802, 0.6591486385438812, 0.6511764087053101, 0.6432805242042965, 0.6354596992117604, 0.6277126914234541, 0.620038309838349, 0.6124353586493801, 0.6049026613271771, 0.5974391049557138, 0.5900435684628492, 0.5827149940488697, 0.5754523033686042, 0.5682544539274702, 0.5611204463202953, 0.5540492906426262, 0.5470400068386484, 0.5400916498426491, 0.5332032876808341, 0.5263740276621783, 0.5196029579812571, 0.5128892139743018, 0.5062319371178566, 0.49963030946311454, 0.49308348874801705, 0.4865906905723803, 0.4801511296453086, 0.4737640220542218, 0.4674286239394672, 0.46114419340714946, 0.45491000419026983, 0.4487253523053233, 0.4425895305195178, 0.43650187992200745, 0.4304617007383697, 0.42446835943281896, 0.41852119744090593, 0.4126195999906737, 0.40676293175081313, 0.40095059414936846, 0.39518199611292704, 0.3894565442351141, 0.38377366721366984, 0.37813280088570944, 0.37253340583265726, 0.36697491828088885, 0.36145682190624995, 0.35597859192520254, 0.3505397049750226, 0.3451396716603401, 0.3397779968332031, 0.3344541776808413, 0.3291677570220375, 0.32391825971998117, 0.31870522065198237, 0.3135281928423253, 0.3083867282150535, 0.3032803927331442, 0.2982087599058485, 0.29317141046954004, 0.2881679211916578, 0.28319789280000107, 0.2782609195321811, 0.27335661308485476, 0.2684845845587385, 0.26364445217653526, 0.25883583962319284, 0.2540583872334276, 0.24931173995898429, 0.2445955234109443, 0.23990940200860927, 0.2352530240719726, 0.23062605489104893, 0.226028164659127, 0.22145901941580518, 0.21691830353569197, 0.2124056961105859, 0.20792088834947636, 0.20346357523212363, 0.19903345261929417, 0.19463021795033447, 0.19025358924347743, 0.1859032638289213, 0.18157897497558617, 0.17728043255512063, 0.17300737041405886, 0.16875950785566826, 0.16453658736089546, 0.16033834486762494, 0.1561645182474179, 0.1520148583547269, 0.14788911573866967, 0.14378703519662492, 0.13970838342648978, 0.13565291464060636, 0.13162039562574507, 0.12761059333929387, 0.12362327902594768, 0.11965822829730398, 0.11571522003737979, 0.11179403338717171, 0.10789445454709606, 0.1040162665180575, 0.10015926875702448, 0.09632324363644014, 0.09250799686339473, 0.08871332016607841, 0.08493902154686564, 0.08118490611516731, 0.07745077559381713, 0.07373644635679352, 0.07004173406373332, 0.0663664459463409, 0.06271040450042163, 0.05907342941475652, 0.055455350159813295, 0.05185598312782599, 0.0482751643601532, 0.04471271784618657, 0.04116847880350374, 0.037642285141560386, 0.03413397422496712, 0.03064338257233768, 0.02717034974618126, 0.023714722623879858, 0.02027634799046625, 0.01685507283910417, 0.013450747274263392, 0.01006322098831099, 0.006692350979657316, 0.0033379925235582104, 0.0};
static double R_vir_grid[] = {15.18065529656441, 15.925493600784296, 16.674711675971103, 17.427944061829038, 18.184859411747208, 18.945154373167366, 19.708555467755573, 20.47481184595652, 21.243696268678033, 22.015001550501406, 22.788538097761215, 23.56413510768225, 24.341634955236792, 25.120894958800047, 25.901785761483225, 26.684189156912087, 27.467997091999003, 28.25311270418113, 29.039446602511386, 29.82691862522834, 30.61545657032834, 31.404994424978778, 32.19547250814414, 32.98683844075815, 33.77904491559714, 34.572048407257334, 35.365810934708975, 36.1602987384217, 36.955483380286026, 37.75133861345804, 38.54784172487117, 39.344973970662636, 40.14272002739384, 40.94106498755316, 41.73999984102047, 42.5395144022704, 43.33960343893665, 44.14026316274985, 44.94149185351456, 45.74328791962124, 46.545653666294555, 47.34859122946094, 48.152106666756936, 48.956204292458786, 49.76089107501738, 50.5661766241067, 51.372069520301324, 52.17857866397027, 52.98571788541095, 53.79349818624536, 54.60193368974876, 55.41103598960331, 56.220822171719355, 57.03130602149787, 57.84250373162309, 58.654433395781986, 59.467109556972865, 60.28055158599886, 61.09477756489379, 61.909805150460976, 62.7256545401968, 63.542345474354505, 64.35989506253709, 65.17832690076177, 65.99765830224797, 66.81791262631663, 67.63910991880786, 68.46127060251735, 69.2844172952149, 70.10857141637993, 70.93375582449039, 71.75999060522382, 72.58729966094779, 73.4157057803554, 74.2452293577454, 75.07589683067116, 75.9077270864196, 76.74074592436995, 77.57497529184964, 78.41043891284795, 79.24715964278629, 80.08516064708661, 80.92446629187198, 81.76509971221368, 82.60708474629529, 83.45044287902809, 84.29520035931525, 85.14137874223965, 85.98900391392304, 86.83809706302007, 87.68868495115991, 88.54078701691965, 89.39443075439272, 90.2496380159993, 91.10643419854894, 91.9648398347125, 92.82488160572598, 93.68658192686995, 94.54996302373932, 95.415050581723, 96.2818681315057, 97.15043734314497, 98.02078391123007, 98.8929292484378, 99.76689820151634, 100.64271308365126, 101.52039712696478, 102.39997492649687, 103.28146831716741, 104.16490030563646, 105.05029523789032, 105.93767397481719, 106.8270623668032, 107.71847980285978, 108.61195156629074, 109.50749933662406, 110.40514789073539, 111.30491591306416, 112.20682818626653, 113.11090769035009, 114.01717606638302, 114.92565360131833, 115.83636543458142, 116.74933216451824, 117.6645756929505, 118.58211844250053, 119.50198278327147, 120.42418858466043, 121.34875930400112, 122.27571666550516, 123.20507950643358, 124.13687042553586, 125.07111291499461, 126.00782572286525, 126.94703164715457, 127.88874846053035, 128.8329994884734, 129.77980639647174, 130.72918803926297, 131.6811647655949, 132.63575838377895, 133.59298868795756, 134.55287633596313, 135.51543911587697, 136.48070008434294, 137.44867819501297, 138.41939400702725, 139.39286460609395, 140.3691130749477, 141.34815631100963, 142.33001362326223, 143.3147064595223, 144.30225240522776, 145.292670945921, 146.28598133026753, 147.2822014242134, 148.28135176255225, 149.28344710850942, 150.2885110081191, 151.2965581095363, 152.30760922763477, 153.3216797439764, 154.33879050183782, 155.35895794171478, 156.38219903707696, 157.4085330529395, 158.43797717517398, 159.47054911111542, 160.50626380327486, 161.54514246933675, 162.5871992622863, 163.63245158334396, 164.6809183017829, 165.73261342189213, 166.78755365004525, 167.84575888328655, 168.90724158112727, 169.97201931275944, 171.04010922805546, 172.11152631059124, 173.1862872792567, 174.26440743300535, 175.34590193980088, 176.4307858698981, 177.5190766095639, 178.61078778219704, 179.70593582017665, 180.80453468622406, 181.9065998278784, 183.0121464533069, 184.12118987762423, 185.23374288415212, 186.34981841919162, 187.46943529235003, 188.5926044318909, 189.7193418282584, 190.8496606394761, 191.9835740213904, 193.12109737171554, 194.26224273655342, 195.4070246487062, 196.55545574873042, 197.70754884185254, 198.86331764364542, 200.02277661844764, 201.1859359208762, 202.35281229569364, 203.52341396632693, 204.69775650494148, 205.87585003568276, 207.05770973015197, 208.24334538360455, 209.43276960900528, 210.62599551604592, 211.82303351472834, 213.02389506151673, 214.22859429851258, 215.4371399279407, 216.64954527716955, 217.86582090009148, 219.0859782283848, 220.3100283271075, 221.5379818391527, 222.76984929602284, 224.005642053884, 225.2453701442336, 226.48904550636064, 227.73667567200098, 228.98827455092865, 230.24384933728737, 231.5034126431866, 232.76697255025567, 234.0345389006429, 235.3061235308307, 236.5817341237522, 237.86137936346142, 239.14507167355762, 240.43281898443487, 241.72463097622787, 243.02051461494472, 244.3204823186732, 245.62454020812459, 246.93269952075025, 248.2449681599609, 249.56135374511425, 250.88186481406856, 252.20651096690955, 253.53530140555043, 254.86824325288686, 256.20534435035046, 257.546613160721, 258.8920576325784, 260.2416865797761, 261.59550659534864, 262.95352562310154, 264.31575266506167};
static double M_vir_grid[] = {40762204767.464386, 44221495349.17134, 47783695619.88188, 51443291055.74954, 55194923041.893974, 59033387591.99814, 62953668267.51471, 66950918730.56676, 71020482793.23483, 75157888039.41019, 79358841869.94673, 83619245139.2026, 87935166774.21062, 92302856844.96347, 96718740036.21451, 101179404613.93637, 105681596925.85637, 110222226950.43196, 114798345878.31602, 119407154704.90514, 124045995064.58203, 128712336643.05331, 133403775545.0078, 138118037536.00287, 142852962163.8341, 147606492213.8346, 152376681418.23035, 157161683737.57715, 161959757187.17175, 166769242177.54523, 171588566820.426, 176416246875.15778, 181250879797.9376, 186091123945.0903, 190935729292.16617, 195783492127.88528, 200633289864.11194, 205484057485.44147, 210334789139.89563, 215184524298.32492, 220032368536.37134, 224877466990.13303, 229719027188.34286, 234556283091.91077, 239388519916.53876, 244215072341.18317, 249035300912.80322, 253848598716.44354, 258654417409.96048, 263452219539.19025, 268241512703.94254, 273021814784.81757, 277792700213.4408, 282553746853.6887, 287304568634.13464, 292044811401.8519, 296774120132.07874, 301492186891.0868, 306198714221.65344, 310893419422.43915, 315576050812.6461, 320246369618.30927, 324904136956.31934, 329549165095.991, 334181244061.1606, 338800211004.21545, 343405896559.72534, 347998145236.018, 352576824937.1339, 357141807447.4958, 361692982605.2495, 366230234593.4792, 370753477783.59644, 375262629080.3381, 379757600732.6721, 384238345658.0141, 388704783512.22485, 393156878393.5123, 397594580525.0027, 402017856149.94836, 406426673101.7315, 410821006790.36536, 415200844524.54297, 419566172498.35895, 423916985666.3687, 428253271737.41956, 432575047567.6804, 436882310307.3969, 441175083384.9959, 445453370372.6439, 449717206751.8675, 453966594864.4069, 458201580778.9286, 462422185659.5921, 466628451313.495, 470820398624.4477, 474998081387.1071, 479161535185.60657, 483310797347.20795, 487445924234.5937, 491566964055.3734, 495673958408.0847, 499766970008.3357, 503846043319.478, 507911240788.9973, 511962614779.39545, 516000223634.55444, 520024133495.61194, 524034399334.50323, 528031082957.71875, 532014253527.93854, 535983965795.7315, 539940298055.05096, 543883300937.65967, 547813052342.5343, 551729615212.92, 555633066978.4812, 559523459489.3319, 563400871968.0991, 567265376526.1241, 571117040296.5259, 574955925481.4653, 578782115466.0112, 582595675057.0065, 586396675187.8245, 590185189493.4924, 593961291858.482, 597725046419.1476, 601476532452.8997, 605215822512.7659, 608942977981.2662, 612658075801.6223, 616361196668.2576, 620052402741.0553, 623731772511.229, 627399365063.0286, 631055261453.4425, 634699536369.4237, 638332253899.3429, 641953484148.7491, 645563302915.2217, 649161778480.3403, 652748982532.1035, 656324976216.351, 659889840394.9056, 663443640742.9724, 666986448946.9324, 670518324136.9723, 674039347294.6134, 677549577043.2778, 681049080836.8383, 684537933720.7897, 688016197015.9406, 691483938820.8606, 694941226380.5404, 698388122141.566, 701824697771.3092, 705251005096.5167, 708667125994.5422, 712073111930.5243, 715469035284.5945, 718854950105.122, 722230928688.1287, 725597028573.7449, 728953309105.897, 732299837083.056, 735636672399.1469, 738963876586.3584, 742281502257.3812, 745589622055.4203, 748888285948.9543, 752177554239.896, 755457491695.9972, 758728147768.5006, 761989580352.8835, 765241857027.2135, 768485022377.4852, 771719136655.2323, 774944258662.7578, 778160440553.1458, 781367739620.7805, 784566208806.1063, 787755900600.5125, 790936867145.1073, 794109167244.6771, 797272848597.1382, 800427966982.2991, 803574570941.1898, 806712713201.8778, 809842445680.3351, 812963820464.2244, 816076882434.3838, 819181676937.0945, 822278265481.0338, 825366687575.1047, 828446996633.3245, 831519238169.3468, 834583457638.6189, 837639706442.0282, 840688026846.2288, 843728467696.2255, 846761072687.4049, 849785885887.355, 852802953656.6987, 855812324155.7249, 858814034265.9185, 861808137789.3942, 864794666515.2305, 867773670977.5541, 870745187730.5094, 873709265981.4823, 876665941303.9547, 879615256273.0814, 882557254553.6737, 885491973045.7083, 888419451172.0681, 891339734761.7369, 894252856330.1125, 897158859499.5565, 900057781096.2362, 902949659960.2452, 905834533956.5398, 908712439863.7358, 911583414118.2555, 914447494979.0498, 917304717529.035, 920155121142.65, 922998735005.0599, 925835602764.0656, 928665752691.7521, 931489225222.6256, 934306050495.6912, 937116262537.2365, 939919899661.4457, 942716990901.4745, 945507567464.943, 948291668590.8418, 951069323613.9921, 953840565581.9376, 956605421649.2627, 959363930511.4382, 962116117356.1896, 964862018114.0925, 967601661567.4962, 970335075851.129, 973062290939.7533, 975783338886.641, 978498250785.1198, 981207053380.2749, 983909774817.6388, 986606444404.6526, 989297090308.3093, 991981742315.3802, 994660425692.8868, 997333168311.6139, 1000000000000.0};
static double fstar_grid[] = {0.0036636176488786453, 0.004212552388878987, 0.004723364026683977, 0.005388018801522796, 0.006146328864353127, 0.006389255185496904, 0.007026393365874295, 0.008346295922779535, 0.009048454562715495, 0.009647314439281735, 0.01082023386330444, 0.011819628362221609, 0.012671822614045859, 0.01362510187691141, 0.014613334825259222, 0.015693489078053124, 0.01678126644237222, 0.01791016392318056, 0.019603118439066973, 0.021117125294492847, 0.022448028941041406, 0.024517442825252058, 0.0262961947907396, 0.02697045301768862, 0.028831745888483334, 0.031316616584848384, 0.033072669490287365, 0.034244048623398894, 0.0345991421645514, 0.03652447069010079, 0.038850393754634636, 0.041251108752679205, 0.04411900916977694, 0.047337691284973435, 0.049822712982813155, 0.052446981220624564, 0.05553171276200812, 0.0587419507578583, 0.0619819292070705, 0.06537558329071819, 0.06873165818145935, 0.07205889283369005, 0.07483903260116574, 0.07766317555381803, 0.08113547745748342, 0.08637187482194315, 0.09274818460799102, 0.09759914184916901, 0.10222707684973481, 0.10660966167775443, 0.11155339121260079, 0.11646157492172005, 0.11956982392430147, 0.12397766725413784, 0.12980802768619495, 0.1339084082898036, 0.13899912455608004, 0.14879985555726996, 0.15404456362281668, 0.15619186070309782, 0.16214645285960874, 0.16839396034999543, 0.17502635494186436, 0.18221811641264987, 0.18952892745132316, 0.1962020683489096, 0.20312116087813317, 0.2103735321068113, 0.2233569010512032, 0.23584959206571282, 0.24053285369800667, 0.2470830370655395, 0.255150921851068, 0.2638101771258776, 0.27248087167202795, 0.28120856203397404, 0.28919786028813643, 0.29672992420515454, 0.3101157318546016, 0.3209040272278305, 0.3273502714478039, 0.3324325596287688, 0.33734396056894117, 0.3462358678308833, 0.3551600625806245, 0.3641536579411899, 0.37637561501718714, 0.3887720177238484, 0.39859582207, 0.4078368129803119, 0.4165418038281183, 0.42086914161359185, 0.42585098350097533, 0.43503763300961146, 0.44387118857739016, 0.4524293020640596, 0.4597207996984491, 0.4675571821639318, 0.47697296242433423, 0.48508162014630235, 0.49244742171160666, 0.501088464755951, 0.5097598623346331, 0.5185708514128992, 0.5267599004491925, 0.5346405277955444, 0.5425689284281444, 0.5494339871925007, 0.5547481898869719, 0.5618845813471663, 0.5695610381366294, 0.576891846405106, 0.585243215179738, 0.5949213575207783, 0.6023219915138532, 0.6088963809651916, 0.6144218693202645, 0.6206066853633443, 0.6275422577246387, 0.6353346770079243, 0.6432655629770693, 0.6511124336007181, 0.6582277301252489, 0.6645963021758832, 0.6718545813725487, 0.6789678890368894, 0.6846898130642848, 0.6909193361892763, 0.6976365749609962, 0.7020127712327656, 0.7062459177732937, 0.7119130767113205, 0.7192543394507654, 0.7281564411160893, 0.7341456250078404, 0.7395038770790522, 0.7445011040645959, 0.7498920040664433, 0.7556493001356753, 0.7610464772705866, 0.7662868069775144, 0.771233010325096, 0.7762131436958548, 0.7812253541779861, 0.7855163994870642, 0.789696989977271, 0.7941535552934939, 0.7985981898887623, 0.8030322520004542, 0.807103393141461, 0.8110985923546121, 0.8152496555612964, 0.8193359644239492, 0.8233537439646877, 0.8273762059739572, 0.8312955145111945, 0.8345449045622947, 0.8380983532232658, 0.8420520045408747, 0.845652153123442, 0.8491336938011645, 0.8527519455884015, 0.8562422676673868, 0.8595530982708507, 0.8620481646752722, 0.864246941177345, 0.8676129360142731, 0.8708705386284523, 0.8739485045742286, 0.8770197403733426, 0.8800765804118142, 0.8829451126419695, 0.8857444376244001, 0.8884158250321111, 0.891159723643407, 0.8939430141260212, 0.8977271899377992, 0.9012770691813738, 0.9038322541564283, 0.9063134220150295, 0.9087304671231041, 0.9111339485216234, 0.913631236821114, 0.9166682044374109, 0.919307162559335, 0.9215092933848457, 0.9225935567453505, 0.9234339450657357, 0.9250071703270232, 0.9268257326509655, 0.9290228801258257, 0.9311986988597908, 0.9333564932374175, 0.9353259430917334, 0.9373678913876667, 0.9395859684363678, 0.9415134154134032, 0.9432547228329116, 0.944948787999176, 0.9466502965756262, 0.9484177228570767, 0.9503626385588657, 0.9524699223640208, 0.9542951911279267, 0.956007165012999, 0.957390765275034, 0.9588100981474423, 0.9602822190832961, 0.961590481236108, 0.962828820491197, 0.9640095863097924, 0.9652631359798989, 0.9666864372718437, 0.9680166432751467, 0.9692840796070553, 0.9705787929186225, 0.9717191289768193, 0.9722350055519574, 0.9733035051501024, 0.974944142062382, 0.9757610379138975, 0.9763851928426759, 0.9774632528171058, 0.978475396340409, 0.979378886009565, 0.9803605211474977, 0.9813798354595096, 0.9823588438363743, 0.9833172107941462, 0.9842275753180327, 0.9851158074098294, 0.9859838811271324, 0.9868531779594607, 0.9877074285195552, 0.988455950680053, 0.9891980638077585, 0.9899324555867643, 0.9906618667530632, 0.9913869351177765, 0.9921006705459788, 0.9927878094058358, 0.9934032181758152, 0.9940005330358316, 0.9945817488380699, 0.9951458181408287, 0.9957031786733926, 0.9962516515030466, 0.9967803972623206, 0.9972792688039378, 0.997751631887825, 0.9982096065454803, 0.9986417646740873, 0.9990603887864579, 0.9994428789344104, 0.999816874001451, 1.0001826571791135};

/* -------- */
double f_star(double t) {
    double ret;
    gsl_interp *intp = gsl_interp_alloc(gsl_interp_linear, interp_grid_size);

    (void) gsl_interp_init(intp, &t_grid, &fstar_grid, interp_grid_size);
    ret = gsl_interp_eval(intp, &t_grid, &fstar_grid, t, NULL);
    gsl_interp_free(intp);

    return ret;
}

/* Get the virial radius, mass at time t */
double R_vir(double t) {
    double ret;
    gsl_interp *intp = gsl_interp_alloc(gsl_interp_linear, interp_grid_size);

    (void) gsl_interp_init(intp, &t_grid, &R_vir_grid, interp_grid_size);
    ret = gsl_interp_eval(intp, &t_grid, &R_vir_grid, t, NULL);
    gsl_interp_free(intp);

    return ret;
}

double M_vir(double t) {
    double ret;
    gsl_interp *intp = gsl_interp_alloc(gsl_interp_linear, interp_grid_size);

    (void) gsl_interp_init(intp, &t_grid, &M_vir_grid, interp_grid_size);
    ret = gsl_interp_eval(intp, &t_grid, &M_vir_grid, t, NULL);
    gsl_interp_free(intp);

    return ret;
}

/* ---------------------------------------------------------------------------
    Hernquist sphere
*/
double growing_hernquist_value(double t, double *pars, double *q, int n_dim) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - c0 - length scale at z=0
    */
    int n_pars = 3;// 3 parameters
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = pars[1] * f_star(t);
    pars_t[2] = pars[2] * R_vir(t) / R_vir0;

    return hernquist_value(t, pars_t, q, n_dim);
}

void growing_hernquist_gradient(double t, double *pars, double *q, int n_dim, double *grad) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - c0 - length scale at z=0
    */
    int n_pars = 3;// 3 parameters
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = pars[1] * f_star(t);
    pars_t[2] = pars[2] * R_vir(t) / R_vir0;

    hernquist_gradient(t, pars_t, q, n_dim, grad);
}

double growing_hernquist_density(double t, double *pars, double *q, int n_dim) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - c0 - length scale at z=0
    */
    int n_pars = 3;// 3 parameters
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = pars[1] * f_star(t);
    pars_t[2] = pars[2] * R_vir(t) / R_vir0;

    return hernquist_density(t, pars_t, q, n_dim);
}

/* ---------------------------------------------------------------------------
    Miyamoto-Nagai flattened potential
*/
double growing_miyamotonagai_value(double t, double *pars, double *q, int n_dim) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - a0 - radial scale length at z=0
            - b - vertical scale length (constant)
    */
    int n_pars = 4;
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = pars[1] * f_star(t);
    pars_t[2] = pars[2] * R_vir(t) / R_vir0;

    return miyamotonagai_value(t, pars_t, q, n_dim);
}

void growing_miyamotonagai_gradient(double t, double *pars, double *q, int n_dim, double *grad) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - a0 - radial scale length at z=0
            - b - vertical scale length (constant)
    */
    int n_pars = 4;
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = pars[1] * f_star(t);
    pars_t[2] = pars[2] * R_vir(t) / R_vir0;

    miyamotonagai_gradient(t, pars_t, q, n_dim, grad);
}

double growing_miyamotonagai_density(double t, double *pars, double *q, int n_dim) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - a0 - radial scale length at z=0
            - b - vertical scale length (constant)
    */

    int n_pars = 4;
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = pars[1] * f_star(t);
    pars_t[2] = pars[2] * R_vir(t) / R_vir0;

    return miyamotonagai_density(t, pars_t, q, n_dim);
}


/* ---------------------------------------------------------------------------
    Spherical NFW
*/
double growing_sphericalnfw_value(double t, double *pars, double *q, int n_dim) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - rs - scale radius (constant)
    */
    double c = R_vir(t) / pars[2];

    int n_pars = 3;
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = M_vir(t) / (log(c+1) - c/(c+1));

    return sphericalnfw_value(t, pars_t, q, n_dim);
}

void growing_sphericalnfw_gradient(double t, double *pars, double *q, int n_dim, double *grad) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - rs - scale radius (constant)
    */
    double c = R_vir(t) / pars[2];

    int n_pars = 3;
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = M_vir(t) / (log(c+1) - c/(c+1));

    sphericalnfw_gradient(t, pars_t, q, n_dim, grad);
}

double growing_sphericalnfw_density(double t, double *pars, double *q, int n_dim) {
    /*  pars:
            - G - Gravitational constant
            - m0 - mass scale at z=0
            - rs - scale radius (constant)
    */

    double c = R_vir(t) / pars[2];

    int n_pars = 3;
    double *pars_t = (double*)malloc(sizeof(double)*n_pars);
    memcpy(pars_t, pars, sizeof(double)*n_pars);
    pars_t[1] = M_vir(t) / (log(c+1) - c/(c+1));

    return sphericalnfw_density(t, pars_t, q, n_dim);
}
